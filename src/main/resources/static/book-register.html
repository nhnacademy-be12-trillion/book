<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë„ì„œ ë“±ë¡ ë°ëª¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .book-cover {
            max-width: 200px;
            max-height: 280px;
            object-fit: cover;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3 text-primary">AIê°€ ë„ì„œ ì •ë³´ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h4>
    <p class="text-muted">Geminiê°€ ëª©ì°¨ì™€ ìš”ì•½ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤ (ì•½ 3~5ì´ˆ ì†Œìš”)</p>
</div>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">ğŸ¤– AI ë„ì„œ ë“±ë¡ ì‹œìŠ¤í…œ</h3>
                </div>
                <div class="card-body">

                    <div class="input-group mb-4">
                        <input type="text" id="isbnInput" class="form-control form-control-lg" placeholder="ISBN 13ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 9791162245538)">
                        <button class="btn btn-dark btn-lg" type="button" onclick="fetchBookInfo()">
                            ğŸ” AI ê²€ìƒ‰
                        </button>
                    </div>

                    <hr>

                    <form id="bookForm">
                        <div class="row mb-3">
                            <div class="col-md-4 text-center">
                                <img id="previewImage" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/150px-No-Image-Placeholder.svg.png" class="book-cover img-fluid rounded mb-2">

                                <input type="hidden" id="bookImage">

                                <div class="mt-2">
                                    <label for="fileInput" class="form-label text-sm text-muted">ì§ì ‘ ì´ë¯¸ì§€ ì—…ë¡œë“œ (ì„ íƒ)</label>
                                    <input class="form-control form-control-sm" type="file" id="fileInput" accept="image/*" onchange="previewFile()">
                                </div>
                            </div>

                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">ISBN</label>
                                    <input type="text" class="form-control" id="isbn" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ë„ì„œëª…</label>
                                    <input type="text" class="form-control fw-bold" id="bookName">
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label">ì¶œíŒì‚¬</label>
                                        <input type="text" class="form-control" id="bookPublisher">
                                    </div>
                                    <div class="col">
                                        <label class="form-label">ì¶œíŒì¼</label>
                                        <input type="date" class="form-control" id="bookPublicationDate">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">ì •ê°€</label>
                                <input type="number" class="form-control" id="bookRegularPrice">
                            </div>
                            <div class="col">
                                <label class="form-label">íŒë§¤ê°€</label>
                                <input type="number" class="form-control" id="bookSalePrice">
                            </div>
                            <div class="col">
                                <label class="form-label">ì¬ê³ </label>
                                <input type="number" class="form-control" id="bookStock" value="10">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">âœ¨ AI ì±… ì†Œê°œ (Description)</label>
                            <textarea class="form-control" id="bookDescription" rows="5"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-success">ğŸ“š AI/ì•Œë¼ë”˜ ëª©ì°¨ (Index)</label>
                            <textarea class="form-control" id="bookIndex" rows="6"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" onclick="registerBook()">
                                ë„ì„œ ë“±ë¡ ì™„ë£Œ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const API_BASE_URL = 'http://localhost:10413/api/books';

    // 1. AI ë„ì„œ ê²€ìƒ‰
    async function fetchBookInfo() {
        const isbn = document.getElementById('isbnInput').value;
        if (!isbn) {
            alert('ISBNì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        document.getElementById('loading').style.display = 'flex';
        // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
        document.getElementById('fileInput').value = '';

        try {
            const response = await fetch(`${API_BASE_URL}/isbn/${isbn}`);
            if (!response.ok) throw new Error('ë„ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            const data = await response.json();
            fillForm(data);
        } catch (error) {
            alert(error.message);
            console.error(error);
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // 2. í¼ ë°ì´í„° ì±„ìš°ê¸°
    function fillForm(data) {
        document.getElementById('isbn').value = data.isbn || '';
        document.getElementById('bookName').value = data.bookName || '';
        document.getElementById('bookPublisher').value = data.bookPublisher || '';
        document.getElementById('bookPublicationDate').value = data.bookPublicationDate || '';
        document.getElementById('bookRegularPrice').value = data.bookRegularPrice || 0;
        document.getElementById('bookSalePrice').value = data.bookSalePrice || 0;
        document.getElementById('bookDescription').value = data.bookDescription || '';
        document.getElementById('bookIndex').value = data.bookIndex || '';

        // ì´ë¯¸ì§€ URL ì±„ìš°ê¸°
        const imgUrl = data.bookImage || '';
        document.getElementById('bookImage').value = imgUrl;

        if (imgUrl) {
            document.getElementById('previewImage').src = imgUrl;
        } else {
            document.getElementById('previewImage').src = "https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/150px-No-Image-Placeholder.svg.png";
        }
    }

    // [ì¶”ê°€] ìˆ˜ë™ íŒŒì¼ ì„ íƒ ì‹œ ë¯¸ë¦¬ë³´ê¸° ë³€ê²½
    function previewFile() {
        const fileInput = document.getElementById('fileInput');
        const preview = document.getElementById('previewImage');
        const file = fileInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onloadend = function () {
                preview.src = reader.result;
            }
            reader.readAsDataURL(file);
            // ìˆ˜ë™ íŒŒì¼ì„ ì„ íƒí–ˆìœ¼ë¯€ë¡œ AI URLì€ ë¹„ì›Œì¤Œ (ì¶©ëŒ ë°©ì§€)
            document.getElementById('bookImage').value = '';
        }
    }

    // 3. ë„ì„œ ë“±ë¡ ìš”ì²­ (CORS í•´ê²° ë²„ì „)
    async function registerBook() {
        // (1) JSON ë°ì´í„° ì¤€ë¹„
        const requestDto = {
            isbn: document.getElementById('isbn').value,
            bookName: document.getElementById('bookName').value,
            bookDescription: document.getElementById('bookDescription').value,
            bookPublisher: document.getElementById('bookPublisher').value,
            bookPublicationDate: document.getElementById('bookPublicationDate').value,
            bookIndex: document.getElementById('bookIndex').value,
            bookPackaging: true,
            bookState: "ON_SALE",
            bookStock: parseInt(document.getElementById('bookStock').value) || 0,
            bookRegularPrice: parseInt(document.getElementById('bookRegularPrice').value) || 0,
            bookSalePrice: parseInt(document.getElementById('bookSalePrice').value) || 0,
            // íŒŒì¼ì´ ì—†ìœ¼ë©´ ì´ URLì„ ì„œë²„ê°€ ë‹¤ìš´ë¡œë“œí•´ì„œ ì‚¬ìš©í•¨
            bookImage: document.getElementById('bookImage').value
        };

        const formData = new FormData();

        // (2) "book" íŒŒíŠ¸ (JSON)
        const jsonBlob = new Blob([JSON.stringify(requestDto)], { type: "application/json" });
        formData.append("book", jsonBlob);

        // (3) "file" íŒŒíŠ¸ (ì´ë¯¸ì§€)
        // [ì¤‘ìš”] ë¸Œë¼ìš°ì €ì—ì„œ fetchë¡œ ì´ë¯¸ì§€ë¥¼ ë‹¤ìš´ë°›ì§€ ì•ŠìŒ (CORS ì—ëŸ¬ ì›ì¸ ì œê±°)
        // ëŒ€ì‹  ì‚¬ìš©ìê°€ ì§ì ‘ ì˜¬ë¦° íŒŒì¼ì´ ìˆì„ ë•Œë§Œ ë³´ëƒ„.
        const fileInput = document.getElementById('fileInput');

        if (fileInput && fileInput.files.length > 0) {
            // ì‚¬ìš©ìê°€ ì§ì ‘ íŒŒì¼ì„ ì„ íƒí•œ ê²½ìš° -> íŒŒì¼ ì „ì†¡
            formData.append("file", fileInput.files[0]);
        }
        // ì‚¬ìš©ìê°€ íŒŒì¼ì„ ì„ íƒí•˜ì§€ ì•Šì€ ê²½ìš° ->
        // formDataì— "file"ì„ ì¶”ê°€í•˜ì§€ ì•ŠìŒ.
        // ë°±ì—”ë“œ Controllerê°€ required=falseì´ë¯€ë¡œ ë¬¸ì œ ì—†ìŒ.
        // ë°±ì—”ë“œ Serviceê°€ requestDto.bookImageë¥¼ ë³´ê³  URL ë‹¤ìš´ë¡œë“œë¥¼ ìˆ˜í–‰í•¨.

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                alert('ğŸ‰ ë„ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                location.reload();
            } else {
                const errorText = await response.text();

                if (errorText.includes("Duplicate")) {
                    alert("â›” ì´ë¯¸ ë“±ë¡ëœ ISBNì…ë‹ˆë‹¤.");
                } else {
                    console.error("ë“±ë¡ ì‹¤íŒ¨:", errorText);
                    alert('ë“±ë¡ ì‹¤íŒ¨! ì½˜ì†” ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.\n' + errorText);
                }
            }
        } catch (error) {
            console.error('Network Error:', error);
            alert('ì„œë²„ í†µì‹  ì˜¤ë¥˜: ' + error.message);
        }
    }
</script>
</body>
</html>