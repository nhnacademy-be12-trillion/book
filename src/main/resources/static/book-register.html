<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë„ì„œ ë“±ë¡ ë°ëª¨</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        .book-cover {
            max-width: 200px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-light">

<div id="loading" class="loading-overlay">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
    <h4 class="mt-3 text-primary">AIê°€ ë„ì„œ ì •ë³´ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h4>
    <p class="text-muted">Geminiê°€ ëª©ì°¨ì™€ ìš”ì•½ì„ ì‘ì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤ (ì•½ 3~5ì´ˆ ì†Œìš”)</p>
</div>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">ğŸ¤– AI ë„ì„œ ë“±ë¡ ì‹œìŠ¤í…œ</h3>
                </div>
                <div class="card-body">

                    <div class="input-group mb-4">
                        <input type="text" id="isbnInput" class="form-control form-control-lg" placeholder="ISBN 13ìë¦¬ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: 9791162245538)">
                        <button class="btn btn-dark btn-lg" type="button" onclick="fetchBookInfo()">
                            ğŸ” AI ê²€ìƒ‰
                        </button>
                    </div>

                    <hr>

                    <form id="bookForm">
                        <div class="row mb-3">
                            <div class="col-md-4 text-center">
                                <img id="previewImage" src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/65/No-Image-Placeholder.svg/150px-No-Image-Placeholder.svg.png" class="book-cover img-fluid rounded mb-2">
                                <input type="hidden" id="bookImage">
                            </div>
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label class="form-label">ISBN</label>
                                    <input type="text" class="form-control" id="isbn" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">ë„ì„œëª…</label>
                                    <input type="text" class="form-control fw-bold" id="bookName">
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <label class="form-label">ì¶œíŒì‚¬</label>
                                        <input type="text" class="form-control" id="bookPublisher">
                                    </div>
                                    <div class="col">
                                        <label class="form-label">ì¶œíŒì¼</label>
                                        <input type="date" class="form-control" id="bookPublicationDate">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label">ì •ê°€</label>
                                <input type="number" class="form-control" id="bookRegularPrice">
                            </div>
                            <div class="col">
                                <label class="form-label">íŒë§¤ê°€</label>
                                <input type="number" class="form-control" id="bookSalePrice">
                            </div>
                            <div class="col">
                                <label class="form-label">ì¬ê³ </label>
                                <input type="number" class="form-control" id="bookStock" value="10">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-primary">âœ¨ AI ì±… ì†Œê°œ (Description)</label>
                            <textarea class="form-control" id="bookDescription" rows="5"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold text-success">ğŸ“š AI/ì•Œë¼ë”˜ ëª©ì°¨ (Index)</label>
                            <textarea class="form-control" id="bookIndex" rows="6"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="button" class="btn btn-primary btn-lg" onclick="registerBook()">
                                ë„ì„œ ë“±ë¡ ì™„ë£Œ
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // [ì¤‘ìš”] ì‚¬ìš© ì¤‘ì¸ ì„œë²„ í¬íŠ¸ í™•ì¸ (ê¸°ì¡´ ë¡œê·¸ ê¸°ë°˜ 10413 ì„¤ì • ìœ ì§€)
    const API_BASE_URL = 'http://localhost:10413/api/books';

    // 1. ISBNìœ¼ë¡œ ì •ë³´ ì¡°íšŒ (GET)
    async function fetchBookInfo() {
        const isbn = document.getElementById('isbnInput').value;
        if (!isbn) {
            alert('ISBNì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
            return;
        }

        document.getElementById('loading').style.display = 'flex'; // ë¡œë”© ì‹œì‘

        try {
            const response = await fetch(`${API_BASE_URL}/isbn/${isbn}`);
            if (!response.ok) throw new Error('ë„ì„œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');

            const data = await response.json();
            fillForm(data); // í¼ ì±„ìš°ê¸°
        } catch (error) {
            alert(error.message);
            console.error(error);
        } finally {
            document.getElementById('loading').style.display = 'none'; // ë¡œë”© ë
        }
    }

    // 2. ë°›ì•„ì˜¨ ë°ì´í„° í¼ì— ì±„ìš°ê¸°
    function fillForm(data) {
        document.getElementById('isbn').value = data.isbn;
        document.getElementById('bookName').value = data.bookName;
        document.getElementById('bookPublisher').value = data.bookPublisher;
        document.getElementById('bookPublicationDate').value = data.bookPublicationDate;
        document.getElementById('bookRegularPrice').value = data.bookRegularPrice;
        document.getElementById('bookSalePrice').value = data.bookSalePrice;
        document.getElementById('bookDescription').value = data.bookDescription;
        document.getElementById('bookIndex').value = data.bookIndex;
        document.getElementById('bookImage').value = data.bookImage;

        // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ê·¸ê±¸ ì“°ê³ , ì—†ìœ¼ë©´ ê¸°ë³¸ ì´ë¯¸ì§€
        if (data.bookImage) {
            document.getElementById('previewImage').src = data.bookImage;
        }
    }

    // 3. ìµœì¢… ë“±ë¡ ìš”ì²­ (POST)
    async function registerBook() {
        const formData = {
            isbn: document.getElementById('isbn').value,
            bookName: document.getElementById('bookName').value,
            bookDescription: document.getElementById('bookDescription').value,
            bookPublisher: document.getElementById('bookPublisher').value,
            bookPublicationDate: document.getElementById('bookPublicationDate').value,
            bookIndex: document.getElementById('bookIndex').value,
            bookPackaging: true, // ê¸°ë³¸ê°’

            // [ìˆ˜ì • í•µì‹¬] Enum íƒ€ì… ë¶ˆì¼ì¹˜ ì—ëŸ¬ í•´ê²° ("SELLING" -> "ON_SALE")
            bookState: "ON_SALE",

            bookStock: parseInt(document.getElementById('bookStock').value),
            bookRegularPrice: parseInt(document.getElementById('bookRegularPrice').value),
            bookSalePrice: parseInt(document.getElementById('bookSalePrice').value),
            bookImage: document.getElementById('bookImage').value
        };

        try {
            const response = await fetch(API_BASE_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                alert('ë„ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                location.reload();
            } else {
                // ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì¢€ ë” ìì„¸íˆ ë³´ê¸° ìœ„í•´
                const errorText = await response.text();
                console.error("ë“±ë¡ ì‹¤íŒ¨:", errorText);
                alert('ë“±ë¡ ì‹¤íŒ¨! (ì½˜ì†” ë¡œê·¸ í™•ì¸)');
            }
        } catch (error) {
            console.error('Network Error:', error);
            alert('ë“±ë¡ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒ');
        }
    }
</script>
</body>
</html>